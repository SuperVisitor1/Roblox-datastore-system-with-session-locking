local DataStoreService = game:GetService("DataStoreService")
local HttpService = game:GetService("HttpService")

local DataStore = DataStoreService:GetDataStore("Fishing_Test")

local LockMaxTime = 100
local JobId = tostring(game.JobId or "")

if JobId == "" then
    JobId = HttpService:GenerateGUID(false)
end

local DataHandler = {}
DataHandler.__index = DataHandler

local function now()
    local currentTime = os.time()
    return currentTime
end

local function mergeDefaults(dest, source)
    if type(source) ~= "table" then
        return dest
    end

    for k, v in pairs(source) do
        local destValue = dest[k]

        if destValue == nil then
            if type(v) == "table" then
                local copy = {}

                for kk, vv in pairs(v) do
                    copy[kk] = vv
                end

                dest[k] = copy
            else
                dest[k] = v
            end
        else
            local isDestTable = type(destValue) == "table"
            local isSourceTable = type(v) == "table"

            if isDestTable and isSourceTable then
                mergeDefaults(destValue, v)
            end
        end
    end

    return dest
end

local function SaveJobIdAndTime(self, DataKey)
    local attempts = 0
    local maxAttempts = 5
    local backoff = 0.4

    while attempts < maxAttempts do
        attempts = attempts + 1

        local ok, err = pcall(function()
            local transformFunction = function(oldData)
                oldData = oldData or {}

                local oldSaved = tostring(oldData.SavedJobID or "0")
                local oldTime = tonumber(oldData.TimeOfTheSave) or 0
                local current = now()

                local isUnlocked = oldSaved == "0"
                local timeDiff = current - oldTime
                local isExpired = timeDiff > LockMaxTime

                if isUnlocked or isExpired then
                    mergeDefaults(self.Data, oldData)

                    self.Data.SavedJobID = JobId
                    self.Data.TimeOfTheSave = current

                    return self.Data
                else
                    return oldData
                end
            end

            DataStore:UpdateAsync(
                DataKey, 
                transformFunction
            )
        end)

        if not ok then
            warn("SaveJobIdAndTime UpdateAsync faile")
        else
            local okGet, currentData = pcall(function()
                return DataStore:GetAsync(DataKey)
            end)

            if okGet then
                if currentData then
                    local savedID = tostring(currentData.SavedJobID or "0")
                    
                    if savedID == JobId then
                        return true
                    end
                end
            end
        end

        task.wait(backoff)

        backoff = backoff * 2
        if backoff > 5 then
            backoff = 5
        end
    end

    warn(
        "Lock not claimed", 
        DataKey
    )

    return false
end

function DataHandler.new(player)
    local self = setmetatable(
        {}, 
        DataHandler
    )

    self.Player = player
    
    self.Data = {
        SavedJobID = "0",
        TimeOfTheSave = 0,
        Coins = 0,
    }

    return self
end

function DataHandler:Save(DataKey)
    local attempt = 0
    local maxAttempts = 5
    local backoff = 1

    while attempt < maxAttempts do
        attempt = attempt + 1

        local success, err = pcall(function()
            local transformFunction = function(oldData)
                oldData = oldData or {}

                local oldSaved = tostring(oldData.SavedJobID or "0")

                if oldSaved == JobId then
                    self.Data.SavedJobID = "0"
                    self.Data.TimeOfTheSave = now()
                    
                    return self.Data
                else
                    return oldData
                end
            end

            DataStore:UpdateAsync(
                DataKey, 
                transformFunction
            )
        end)

        if success then
            local okGet, currentData = pcall(function()
                return DataStore:GetAsync(DataKey)
            end)

            if okGet and currentData then
                local savedID = tostring(currentData.SavedJobID or "0")
                
                if savedID == "0" then
                    return true
                end
            else
                local dataString = tostring(currentData)
                warn(
                    "GetAsync verification failed", 
                    dataString
                )
                return true
            end
        else
            warn("Save UpdateAsync failed")
        end

        task.wait(backoff)

        backoff = backoff * 2
        if backoff > 8 then
            backoff = 8
        end
    end

    return false
end

function DataHandler:Load(Player, DataKey)
    local ReturnedData
    local currentTime = now()

    local success, err = pcall(function()
        ReturnedData = DataStore:GetAsync(DataKey)
    end)

    if not success then
        local errorString = tostring(err)
        warn(
            "Failed to load data:", 
            errorString
        )

        Player:Kick("Data loading failed. Please rejoin.")
        return
    end

    if ReturnedData then
        print("Loaded successful")
    end

    local savedIdStr
    local savedTime

    if ReturnedData then
        savedIdStr = tostring(ReturnedData.SavedJobID)
    else
        savedIdStr = "0"
    end

    if ReturnedData then
        savedTime = tonumber(ReturnedData.TimeOfTheSave)
    else
        savedTime = 0
    end
    
    if not savedTime then
        savedTime = 0
    end

    local isUnlocked = false
    
    if ReturnedData then
        if savedIdStr == "0" then
            isUnlocked = true
        end
    else
        isUnlocked = true 
    end

    if isUnlocked then
        if ReturnedData then
            mergeDefaults(self.Data, ReturnedData)
        end
        
        SaveJobIdAndTime(self, DataKey)
        
        return
    end

    if ReturnedData then
        if savedIdStr ~= "0" then
            local timeDiff = currentTime - savedTime
            
            if timeDiff < LockMaxTime then
                Player:Kick("Multiple sessions detected. Please close other sessions and rejoin.")
                return
            end
        end
    end

    if ReturnedData then
        if savedIdStr ~= "0" then
            local timeDiff = currentTime - savedTime
            
            if timeDiff > LockMaxTime then
                mergeDefaults(self.Data, ReturnedData)
                SaveJobIdAndTime(self, DataKey)
                
                return
            end
        end
    end

    SaveJobIdAndTime(self, DataKey)
end

return DataHandler
